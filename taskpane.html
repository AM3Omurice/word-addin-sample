<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sample Word Add-in</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; font-size: 16px; }
        pre { background: #f5f5f5; padding: 12px; border-radius: 6px; }
    </style>
    <!-- Office.js を CDN から読み込み -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <!-- MSAL.js を CDN から読み込み -->
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
</head>
<body>
    <h1>Sample Word Add-in</h1>

    <button id="btnUser">ユーザー情報を表示</button>

    <h2>結果</h2>
    <div id="status">準備中...</div>
    <div id="userPhoto" style="margin: 10px 0;"></div>
    <pre id="claims"></pre>

    <script>
      // MSAL 設定
      const msalConfig = {
        auth: {
          clientId: 'ce1db0ef-5d35-4a00-a8ee-d4fba99e60ad',
          authority: 'https://login.microsoftonline.com/common',
          redirectUri: 'https://am3omurice.github.io/word-addin-sample/taskpane.html'
        },
        cache: {
          cacheLocation: 'localStorage',
          storeAuthStateInCookie: false
        }
      };

      const msalInstance = new msal.PublicClientApplication(msalConfig);

      // Base64URL をデコードして JSON を返すユーティリティ
      function decodeJwt(jwt) {
        // JWT は 3 区切り: header.payload.signature
        const parts = jwt.split('.');
        if (parts.length < 2) throw new Error('Invalid JWT');
        const base64url = parts[1];
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + '='.repeat((4 - base64url.length % 4) % 4);
        const json = atob(base64);
        return JSON.parse(json);
      }

      Office.onReady(async () => {
        document.getElementById('status').textContent = '準備完了。ボタンを押してください。';

        document.getElementById('btnUser').addEventListener('click', async () => {
          const status = document.getElementById('status');
          const claimsEl = document.getElementById('claims');

          status.textContent = 'サインイン／トークン取得中...';

          try {
            // SSO トークン取得（必要に応じてサインイン／同意ダイアログが表示されます）
            // OfficeRuntime.auth と Office.auth は同等です。ここでは OfficeRuntime を使用。
            const token = await OfficeRuntime.auth.getAccessToken({
              allowSignInPrompt: true,   // 未サインインならプロンプト
              allowConsentPrompt: true   // 初回の権限同意を許可
              // forceAddAccount: false, // 必要なら追加
            });

            // JWT をデコードしてクレームを取り出す
            const claims = decodeJwt(token);

            // 代表的なクレーム（テナントや環境によりキーが異なる場合あり）
            const displayName = claims.name || claims.preferred_username || claims.email || '(unknown)';
            const userPrincipal = claims.preferred_username || claims.upn || claims.email || '';
            const oid = claims.oid || claims.sub || '';

            status.textContent = '取得成功。以下がユーザー情報です。';
            claimsEl.textContent = JSON.stringify({
              displayName,
              userPrincipal,
              objectId: oid,
              issuer: claims.iss,
              audience: claims.aud,
              tenantId: claims.tid,
              exp: claims.exp
            }, null, 2);

            // Graph API用のトークンを取得（MSAL使用）
            const photoEl = document.getElementById('userPhoto');
            let graphToken = null;
            
            const account = msalInstance.getAllAccounts()[0];
            
            if (account) {
              // アカウントがある場合はサイレント認証を試行
              try {
                const silentResult = await msalInstance.acquireTokenSilent({
                  scopes: ['User.Read'],
                  account: account
                });
                graphToken = silentResult.accessToken;
              } catch (silentError) {
                console.error('Silent auth failed:', silentError);
                // サイレント失敗時はポップアップで認証
                try {
                  const loginResult = await msalInstance.acquireTokenPopup({
                    scopes: ['User.Read']
                  });
                  graphToken = loginResult.accessToken;
                } catch (loginError) {
                  photoEl.innerHTML = `<p style="font-size: 12px; color: #d13438;">Graph API認証失敗: ${loginError.message || loginError}</p>`;
                  console.error('Login error:', loginError);
                }
              }
            } else {
              // アカウントがない場合は直接ポップアップで認証
              try {
                const loginResult = await msalInstance.acquireTokenPopup({
                  scopes: ['User.Read']
                });
                graphToken = loginResult.accessToken;
              } catch (loginError) {
                photoEl.innerHTML = `<p style="font-size: 12px; color: #d13438;">Graph API認証失敗: ${loginError.message || loginError}</p>`;
                console.error('Login error:', loginError);
              }
            }

            // プロフィール写真を取得
            if (graphToken) {
              try {
                const photoResponse = await fetch('https://graph.microsoft.com/v1.0/me/photo/$value', {
                  headers: {
                    'Authorization': 'Bearer ' + graphToken
                  }
                });

              if (photoResponse.ok) {
                const photoBlob = await photoResponse.blob();
                const photoUrl = URL.createObjectURL(photoBlob);
                photoEl.innerHTML = `<img src="${photoUrl}" alt="User Photo" style="width: 100px; height: 100px; border-radius: 50%;"><p style="font-size: 12px; color: #666;">カスタム写真を表示</p>`;
              } else if (photoResponse.status === 404) {
                // デフォルト写真の場合（404 Not Found）
                const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                photoEl.innerHTML = `<div style="width: 100px; height: 100px; border-radius: 50%; background: #0078d4; color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold;">${initials}</div><p style="font-size: 12px; color: #666;">デフォルト写真（カスタム写真未設定）</p>`;
              } else {
                // その他のエラー
                const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                photoEl.innerHTML = `<div style="width: 100px; height: 100px; border-radius: 50%; background: #0078d4; color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold;">${initials}</div><p style="font-size: 12px; color: #d13438;">写真取得エラー (status: ${photoResponse.status})</p>`;
              }
              } catch (photoErr) {
                // ネットワークエラーなど
                const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                photoEl.innerHTML = `<div style="width: 100px; height: 100px; border-radius: 50%; background: #0078d4; color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: bold;">${initials}</div><p style="font-size: 12px; color: #d13438;">写真取得失敗: ${photoErr.message || photoErr}</p>`;
                console.error('Photo error:', photoErr);
              }
            }
          } catch (err) {
            // 代表的なエラー：
            // 13001: ユーザーが Office にサインインしていない（Outlook Web/Safari など特例あり）
            // 13012: SSO 構成／同意の問題
            status.textContent = `取得失敗: ${err && err.message ? err.message : err}`;
            claimsEl.textContent = '';
          }
        });
      });
    </script>
</body>
